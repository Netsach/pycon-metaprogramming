<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>A RESTful way of dealing with asynchronous tasks in Django</title><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="css/style.css" media="screen,projection"></link></head><body class="impress-not-supported"><div id="impress"><div class="step step-level-1" step="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="0" data-y="0" data-z="0"><h1 id="async-rest">async-rest</h1><h2 id="a-restful-way-of-dealing-with-asynchronous-tasks">A RESTful way of dealing with asynchronous tasks</h2><h3 id="meetup-paris-py-11-drivy-2016-09-27">Meetup Paris.py #11 - Drivy - 2016-09-27</h3><h3 id="pa-schembri-http-netsach-com">@pa_schembri (<a href="http://netsach.com">http://netsach.com</a>)</h3></div><div class="step step-level-1" step="1" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="1600" data-y="0" data-z="0"><h1 id="sommaire">Sommaire</h1><ul><li>REST, resources et actions</li><li>Starbucks Paradigm</li><li>Pr&#xE9;sentation et int&#xE9;gration de django-async-rest</li><li>Exemple concret &amp; retours d'exp&#xE9;rience</li></ul></div><div class="step step-level-1" step="2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="3200" data-y="0" data-z="0"><h1 id="rest-resources-actions">REST : Resources &amp; Actions</h1></div><div class="step step-level-1" step="3" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="4800" data-y="0" data-z="0"><h1 id="id1">REST : Resources &amp; Actions</h1><p>API Endpoint : <tt>https://my.todoapp.com/todo/[&lt;id&gt;/]</tt></p><p>Actions disponibles :</p><ul><li>POST -&gt; Create</li><li>GET -&gt; Read</li><li>PUT -&gt; Update</li><li>DELETE -&gt; Destroy</li></ul><div class="notes"><ul><li>Exemple de la todo app et de la gestion des actions sur les t&#xE2;ches</li><li>Simple et pratique pour les ressources "simples"</li></ul></div></div><div class="step step-level-1" step="4" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="6400" data-y="0" data-z="0"><h1 id="duree-de-traitements-o-s">Dur&#xE9;e de traitements &gt; O(s)</h1><ul><li>Traitements en batch</li><li>Calculs sur base de donn&#xE9;es <em>Big Data</em></li><li>Int&#xE9;raction avec des &#xE9;quipements hardware</li><li>...</li></ul></div><div class="step step-level-1" step="5" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8000" data-y="0" data-z="0"><h1 id="solutions">Solutions...</h1><ul><li>HTTP Long polling</li><li>[Web]sockets</li><li>Event loop, asyncio, async &amp; await</li><li>...</li></ul><h2 id="trop-contraignantes">... trop contraignantes</h2></div><div class="step step-level-1" step="6" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="9600" data-y="0" data-z="0"><h1 id="solution-elegante-task-queues">Solution &#xE9;l&#xE9;gante : Task queues</h1><ul><li>Celery</li><li>RQ</li><li>other task queue managers</li></ul><p>REST ? :</p><ul><li><tt>celery.task.http</tt> : webhooks ?</li><li>RQ ? Autres ?</li></ul></div><div class="step step-level-1" step="7" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11200" data-y="0" data-z="0"><h1 id="integration-rest">Int&#xE9;gration REST !!!</h1></div><div class="step step-level-1" step="8" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12800" data-y="0" data-z="0"><h1 id="starbucks-paradigm">Starbucks Paradigm</h1><h2 id="rest-appliquee-a-la-vie-reelle">REST appliqu&#xE9;e &#xE0; la vie r&#xE9;elle</h2></div><div class="step step-level-1" step="9" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14400" data-y="0" data-z="0"><h1 id="id2">Starbucks Paradigm</h1><p>ou comment appliquer REST dans le monde r&#xE9;el...</p><ol><li>Commande d'un caf&#xE9; (order)</li><li>Attente... (caf&#xE9; en cours de production, running task)</li><li>O&#xF9; en est-on ? (polling)</li><li>Livraison du caf&#xE9; (callback / polling)<blockquote><p>R&#xE9;f&#xE9;rence : "REST In practice (ISBN : 978-0596805821)"</p></blockquote></li></ol></div><div class="step step-level-1" step="10" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="16000" data-y="0" data-z="0"><h1 id="proposition-d-un-workflow-rest-1-2">Proposition d'un workflow REST (1/2)</h1><ol><li>Commande d'une pizza : <tt>POST /regina/order</tt></li><li><tt>POST =&gt; 302 =&gt; location: /orders/be7aa21c/</tt></li><li>Attente... msg = 'la pizza est au four...'</li><li>O&#xF9; en est-on ? ... msg = 'livreur en route...'</li></ol></div><div class="step step-level-1" step="11" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="17600" data-y="0" data-z="0"><h1 id="proposition-d-un-workflow-rest-2-2">Proposition d'un workflow REST (2/2)</h1><pre class="highlight code http"><span class="nf">GET</span> <span class="nn">/orders/be7aa21c/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>

HTTP/1.1 202 ACCEPTED
order : regina
status : queued</pre><pre class="highlight code http"><span class="nf">GET</span> <span class="nn">/orders/be7aa21c/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>

HTTP/1.1 201 CREATED
order : regina
resource-url : /regina/ca4a5619/
status : completed</pre></div><div class="step step-level-1" step="12" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="19200" data-y="0" data-z="0"><h1 id="id3">async-rest</h1></div><div class="step step-level-1" step="13" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="20800" data-y="0" data-z="0"><h1 id="en-bref">En bref</h1><ul><li>App Django</li><li>Compatible Celery, RQ, et <tt>.apply_async(...)</tt></li><li>django-async-rest</li><li>Bas&#xE9;e sur django-rest-framework</li></ul><div class="notes"><p>On rassemble ces m&#xE9;canismes, on les applique au traitements de taches asynchrones et on int&#xE8;gre tout &#xE7;a dans une librairie d&#xE9;di&#xE9;e.</p><p>abstraction de la gestion des t&#xE2;ches asynchrones</p></div></div><div class="step step-level-1" step="14" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="22400" data-y="0" data-z="0"><h1 id="integration">Int&#xE9;gration</h1><pre class="highlight code python"><span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">cook_pizza</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="o">...</span>

<span class="kn">from</span> <span class="nn">async_rest.dispatcher</span> <span class="kn">import</span> <span class="n">register</span>
<span class="o">...</span>
<span class="n">register</span><span class="p">(</span><span class="s1">'regina'</span><span class="p">,</span> <span class="n">cook_pizza</span><span class="p">))</span>
<span class="n">register</span><span class="p">(</span><span class="s1">'margherita'</span><span class="p">,</span> <span class="n">cook_pizza</span><span class="p">))</span>
<span class="o">...</span></pre><div class="notes"><p>L'int&#xE9;gration consiste &#xE0; lier des resources &#xE0; des t&#xE2;ches : ressources qui sont issues d'une t&#xE2;che asynchrone.</p></div></div><div class="step step-level-1" step="15" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="24000" data-y="0" data-z="0"><h1 id="generation-des-endpoints">G&#xE9;n&#xE9;ration des endpoints</h1><p>Cr&#xE9;ation automatique des endpoints accessible via tout type de client HTTP (javascript in-browser, curl, requests, ...)</p><pre class="highlight code text">/async/regina/order/ [POST only]
/async/&lt;resource-name&gt;/order/ [POST only]
/async/orders/&lt;uuid&gt;/ [GET only]</pre></div><div class="step step-level-1" step="16" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="25600" data-y="0" data-z="0"><h1 id="helpers">Helpers</h1><p><tt>async_rest.helpers.fail_on_error</tt></p><pre class="highlight code python"><span class="k">with</span> <span class="n">fail_on_error</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="s1">'No more ingredients'</span><span class="p">):</span>
    <span class="n">pizza_kind</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">resource_name</span>

    <span class="c1"># may raise exceptions</span>
    <span class="n">ingredients</span> <span class="o">=</span> <span class="n">retrieve_ingredients</span><span class="p">(</span><span class="n">pizza_kind</span><span class="p">)</span>
    <span class="o">...</span></pre><div class="notes"><p>helper que l'on peut int&#xE9;grer dans les t&#xE2;ches afin de g&#xE9;rer automatiquement les &#xE9;tat (succ&#xE8;s / &#xE9;chec)</p></div></div><div class="step step-level-1" step="17" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="27200" data-y="0" data-z="0"><h1 id="id4">Helpers</h1><pre class="highlight code python"><span class="c1"># async_rest.helpers.ProgressItems</span>

<span class="k">with</span> <span class="n">ProgressItems</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">csvreader</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span> <span class="k">as</span> <span class="n">rows</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">process_invoice</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="o">...</span>

<span class="n">order</span><span class="o">.</span><span class="n">progress</span> <span class="p">:</span> <span class="mi">10</span><span class="o">%</span>
<span class="n">order</span><span class="o">.</span><span class="n">progress</span> <span class="p">:</span> <span class="mi">20</span><span class="o">%</span>
<span class="o">...</span>
<span class="n">order</span><span class="o">.</span><span class="n">progress</span> <span class="p">:</span> <span class="mi">100</span><span class="o">%</span></pre><div class="notes"><p>helper que l'on peut int&#xE9;grer dans les t&#xE2;ches afin de g&#xE9;rer automatiquement la progression de la commande</p></div></div><div class="step step-level-1" step="18" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="28800" data-y="0" data-z="0"><h1 id="api-interne">API Interne</h1><pre class="highlight code python"><span class="c1"># async_rest.models.Order</span>

<span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="n">resource_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<span class="n">order</span><span class="o">.</span><span class="n">queue</span><span class="p">()</span>
<span class="o">...</span>
<span class="n">order</span><span class="o">.</span><span class="n">fail</span><span class="p">()</span>
<span class="o">...</span>
<span class="n">order</span><span class="o">.</span><span class="n">resource</span><span class="o">-</span><span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">'ns:pizza'</span><span class="p">,</span> <span class="p">(</span><span class="n">pizza</span><span class="o">.</span><span class="n">pk</span><span class="p">,))</span>
<span class="n">order</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="o">...</span></pre><div class="notes"><p>API simple
resource_name
context : contexte d'ex&#xE9;cution de la t&#xE2;che</p></div></div><div class="step step-level-1" step="19" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="30400" data-y="0" data-z="0"><h1 id="exemple-concret-retours-d-experience">Exemple concret &amp; retours d'exp&#xE9;rience</h1></div><div class="step step-level-1" step="20" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="32000" data-y="0" data-z="0"><img src="img/ex1.png"></img><div class="notes"><p>Projet : client m&#xE9;dia</p><p>Frontend en javascript
2 backends</p><ul><li>Premier d&#xE9;di&#xE9; &#xE0; l'interface utilisateur</li><li>Deuxi&#xE8;me backend : Traitement machine (archivage media)</li></ul><p>Workflow :
1. un utilisateur pousse un fichier CSV avec des identifiers de m&#xE9;dias et des chemins d'acc&#xE8;s
2. Le fichier est trait&#xE9; relativement rapidement (v&#xE9;rification de base)
3. Le process d'archivage - tr&#xE8;s long (plusieurs heures) est r&#xE9;alis&#xE9; sur une autre infrastructure distante
4. Ici, double utilisation de async rest : Javascript et Client REST Python</p></div></div><div class="step step-level-1" step="21" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="33600" data-y="0" data-z="0"><h1 id="retours-d-experience">Retours d'exp&#xE9;rience</h1><ul><li>M&#xE9;canisme initial pas 100% REST</li><li>Tentation du RPC / SOAP</li><li>Effort particulier dans la terminologie (action / resource)</li><li>D&#xE9;pendance &#xE0; Django / DRF / Celery</li></ul></div><div class="step step-level-1" step="22" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="35200" data-y="0" data-z="0"><h1 id="roadmap">Roadmap</h1><ul><li>D&#xE9;couplage Django / DRF</li><li>Ajout du m&#xE9;canisme de callback</li><li>Am&#xE9;liorer compatibilit&#xE9; Py3</li><li>Ajout d'autres helpers (<tt>post_on_completion</tt>, ...)</li><li>contact : <a href="mailto:pa.schembri@netsach.com">pa.schembri@netsach.com</a></li></ul></div><div class="step step-level-1" step="23" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="36800" data-y="0" data-z="0"><h1 id="q-a">Q &amp; A</h1><pre class="highlight code text">GET /end-of-talk/
HTTP/1.1 406 Not Acceptable</pre><ul><li>We're hiring !</li><li>Projet : <a href="https://github.com/Netsach/django-async-rest">https://github.com/Netsach/django-async-rest</a></li><li>Website : <a href="http://netsach.com">http://netsach.com</a></li><li>Contact : <a href="mailto:pa.schembri@netsach.com">pa.schembri@netsach.com</a></li></ul></div></div><div id="hovercraft-help" class="hide"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Right, Down, Page Down</th><td>Next slide</td></tr><tr><th>Left, Up, Page Up</th><td>Previous slide</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script></body></html>